{"version":3,"mappings":"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","names":["browserAPI","CometStorageManager","defaultsModule","__vitePreload","key","value","error","keys","fallback","result","output","merged","data","callback","listener","changes","namespace","storage"],"ignoreList":[],"sources":["../src/platform/storage.js"],"sourcesContent":["/**\n * Comet Framework - Essential Storage Utility (Cross-Browser)\n * Simple storage with auto-loading defaults\n * @module @voilajsx/comet\n * @file src/platform/storage.js\n */\n\n// Cross-browser API detection\nconst browserAPI = (() => {\n  if (typeof browser !== 'undefined') {\n    return browser; // Firefox, newer browsers\n  } else if (typeof chrome !== 'undefined') {\n    return chrome; // Chrome, Edge, Opera, Brave\n  } else {\n    throw new Error('No browser extension API available');\n  }\n})();\n\n/**\n * Essential Comet Storage Manager\n * Auto-loads defaults and provides simple get/set/remove API\n */\nclass CometStorageManager {\n  constructor() {\n    this.api = browserAPI;\n    this.defaults = {};\n    this.defaultsLoaded = false;\n    this.isInitialized = false;\n\n    this.initialize();\n  }\n\n  /**\n   * Initialize storage with auto-loading defaults\n   */\n  async initialize() {\n    if (this.isInitialized) return;\n\n    try {\n      await this.loadDefaults();\n      await this.initializeDefaults();\n      this.isInitialized = true;\n      console.log('[Comet Storage] Initialized with defaults');\n    } catch (error) {\n      console.warn(\n        '[Comet Storage] No defaults found, continuing without defaults'\n      );\n      this.defaults = {};\n      this.defaultsLoaded = true;\n      this.isInitialized = true;\n    }\n  }\n\n  /**\n   * Load defaults from defaults.json\n   */\n  async loadDefaults() {\n    if (this.defaultsLoaded) return;\n\n    try {\n      const defaultsModule = await import('../defaults.json');\n      this.defaults = defaultsModule.default || {};\n      this.defaultsLoaded = true;\n      console.log('[Comet Storage] Loaded defaults from defaults.json');\n    } catch (error) {\n      this.defaults = {};\n      this.defaultsLoaded = true;\n    }\n  }\n\n  /**\n   * Initialize storage with defaults on first run\n   */\n  async initializeDefaults() {\n    try {\n      const isInitialized = await this.api.storage.local.get(\n        '_defaultsInitialized'\n      );\n\n      if (isInitialized._defaultsInitialized) {\n        return; // Already initialized\n      }\n\n      // Set defaults for any keys that don't exist\n      if (Object.keys(this.defaults).length > 0) {\n        for (const [key, value] of Object.entries(this.defaults)) {\n          const existing = await this.api.storage.sync.get(key);\n          if (existing[key] === undefined) {\n            await this.api.storage.sync.set({ [key]: value });\n          }\n        }\n        console.log('[Comet Storage] Initialized with defaults');\n      }\n\n      await this.api.storage.local.set({ _defaultsInitialized: true });\n    } catch (error) {\n      console.warn('[Comet Storage] Failed to initialize defaults:', error);\n    }\n  }\n\n  /**\n   * Get data from storage with auto-fallback to defaults\n   * @param {string|array} keys - Keys to retrieve\n   * @param {any} fallback - Fallback value if not found\n   * @returns {Promise<any>} Retrieved data\n   */\n  async get(keys, fallback = undefined) {\n    try {\n      await this.initialize();\n\n      // Handle single key\n      if (typeof keys === 'string') {\n        const result = await this.api.storage.sync.get(keys);\n\n        if (result[keys] !== undefined) {\n          return result[keys];\n        }\n\n        // Try defaults\n        if (this.defaults[keys] !== undefined) {\n          return this.defaults[keys];\n        }\n\n        return fallback;\n      }\n\n      // Handle array of keys\n      if (Array.isArray(keys)) {\n        const result = await this.api.storage.sync.get(keys);\n        const output = {};\n\n        for (const key of keys) {\n          if (result[key] !== undefined) {\n            output[key] = result[key];\n          } else if (this.defaults[key] !== undefined) {\n            output[key] = this.defaults[key];\n          } else {\n            output[key] = undefined;\n          }\n        }\n\n        return output;\n      }\n\n      // Handle null (get all)\n      if (keys === null) {\n        const result = await this.api.storage.sync.get(null);\n\n        // Merge with defaults\n        const merged = { ...this.defaults };\n        Object.assign(merged, result);\n        delete merged._defaultsInitialized; // Remove internal flag\n\n        return merged;\n      }\n\n      return fallback;\n    } catch (error) {\n      console.error('[Comet Storage] Get operation failed:', error);\n      throw new Error('Failed to read from storage: ' + error.message);\n    }\n  }\n\n  /**\n   * Set data to storage\n   * @param {object|string} data - Data to store (object) or key (string)\n   * @param {any} [value] - Value if first param is key string\n   * @returns {Promise<boolean>} Success status\n   */\n  async set(data, value = undefined) {\n    try {\n      await this.initialize();\n\n      // Handle set(key, value) syntax\n      if (typeof data === 'string') {\n        await this.api.storage.sync.set({ [data]: value });\n        return true;\n      }\n\n      // Handle object syntax\n      if (typeof data === 'object' && data !== null) {\n        await this.api.storage.sync.set(data);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error('[Comet Storage] Set operation failed:', error);\n      throw new Error('Failed to write to storage: ' + error.message);\n    }\n  }\n\n  /**\n   * Remove data from storage\n   * @param {string|array} keys - Keys to remove\n   * @returns {Promise<boolean>} Success status\n   */\n  async remove(keys) {\n    try {\n      await this.api.storage.sync.remove(keys);\n      return true;\n    } catch (error) {\n      console.error('[Comet Storage] Remove operation failed:', error);\n      throw new Error('Failed to remove from storage: ' + error.message);\n    }\n  }\n\n  /**\n   * Clear all data from storage\n   * @returns {Promise<boolean>} Success status\n   */\n  async clear() {\n    try {\n      await this.api.storage.sync.clear();\n      await this.api.storage.local.clear();\n      return true;\n    } catch (error) {\n      console.error('[Comet Storage] Clear operation failed:', error);\n      throw new Error('Failed to clear storage: ' + error.message);\n    }\n  }\n\n  /**\n   * Check if key exists in storage (including defaults)\n   * @param {string} key - Key to check\n   * @returns {Promise<boolean>} True if key exists\n   */\n  async has(key) {\n    try {\n      const value = await this.get(key);\n      return value !== undefined;\n    } catch (error) {\n      return false;\n    }\n  }\n\n  /**\n   * Listen to storage changes\n   * @param {function} callback - Callback function (changes, namespace) => void\n   * @returns {function} Unsubscribe function\n   */\n  onChange(callback) {\n    const listener = (changes, namespace) => {\n      callback(changes, namespace);\n    };\n\n    this.api.storage.onChanged.addListener(listener);\n\n    // Return unsubscribe function\n    return () => {\n      this.api.storage.onChanged.removeListener(listener);\n    };\n  }\n\n  /**\n   * Get all defaults\n   * @returns {object} Defaults object\n   */\n  getDefaults() {\n    return JSON.parse(JSON.stringify(this.defaults));\n  }\n}\n\n/**\n * Storage error class\n */\nclass CometStorageError extends Error {\n  constructor(message, originalError) {\n    super(message);\n    this.name = 'CometStorageError';\n    this.originalError = originalError;\n  }\n}\n\n// Create and export storage instance\nexport const storage = new CometStorageManager();\n\n// Export class for advanced usage\nexport { CometStorageManager, CometStorageError };\n"],"file":"storage-CjHHMo7h.js"}